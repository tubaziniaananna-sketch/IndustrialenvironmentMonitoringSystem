<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Monitor | Sky Edition v3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { --bg-body: #f0f9ff; --bg-card: #ffffff; --text-main: #0c4a6e; --accent-border: #bae6fd; --fan-color: #cbd5e1; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; transition: 0.5s; }
        .card { background-color: var(--bg-card); border: 1px solid var(--accent-border); border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .progress { background-color: #e2e8f0; overflow: hidden; }
        .system-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem 0.5rem; border-bottom: 1px solid var(--accent-border); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spin-active { animation: spin 0.8s linear infinite; }
        .hazard-bg { background-color: #fee2e2 !important; }
        .form-switch .form-check-input { width: 3em; height: 1.5em; cursor: pointer; }
        
        .theft-banner { display: none; background-color: #dc2626; color: white; text-align: center; padding: 12px; font-weight: bold; }
        
        /* Offline pulse effect */
        @keyframes pulse-offline {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .offline-pulse { animation: pulse-offline 2s infinite; }
    </style>
</head>
<body>

<div id="theftBanner" class="theft-banner">
    <div class="d-flex justify-content-center align-items-center">
        <i class="bi bi-shield-exclamation me-2 fs-5"></i> 
        <span class="fs-5 me-4">INTRUDER ALERT DETECTED</span>
        <button class="btn btn-light btn-sm fw-bold text-danger" onclick="stopAlert()">STOP ALERT</button>
    </div>
</div>

<div class="container py-5">
    <div class="row mb-5 text-center">
        <div class="col-12">
            <h1 class="fw-bold display-5" style="color: #0284c7;"><i class="bi bi-clouds-fill me-2"></i>Lab Monitor <span style="font-weight: 300;">Sky</span></h1>
            <p class="text-muted">Device-1 Status Panel</p>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="row g-4">
                <div class="col-md-6"><div class="card h-100 p-4"><h6>Temp</h6><h2 class="display-4 fw-bold"><span id="valTemp">--</span><small class="fs-4 text-muted">°C</small></h2></div></div>
                <div class="col-md-6"><div class="card h-100 p-4"><h6>Humidity</h6><h2 class="display-4 fw-bold"><span id="valHum">--</span><small class="fs-4 text-muted">%</small></h2><div class="progress mt-2"><div id="barHum" class="progress-bar bg-info" style="width: 0%"></div></div></div></div>
                <div class="col-md-6"><div class="card h-100 p-4"><h6>Vibration</h6><h3 id="valVib" class="fw-bold text-muted">--</h3></div></div>
                <div class="col-md-6"><div class="card h-100 p-4"><h6>Motion</h6><h3 id="valMotion" class="fw-bold text-muted">--</h3></div></div>
                <div class="col-md-6"><div class="card h-100 p-4"><h6>Combustible</h6><h2 class="display-4 fw-bold"><span id="valSmoke">--</span><small class="fs-4 text-muted"> PPM</small></h2><div class="progress mt-2"><div id="barSmoke" class="progress-bar bg-warning" style="width: 0%"></div></div></div></div>
                <div class="col-md-6"><div class="card h-100 p-4"><h6>Air Quality</h6><h2 class="display-4 fw-bold"><span id="valGas">--</span><small class="fs-4 text-muted"> PPM</small></h2><div class="progress mt-2"><div id="barGas" class="progress-bar bg-success" style="width: 0%"></div></div></div></div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100 p-4">
                <div class="card bg-light border-0 mb-4 p-3">
                    <div class="form-check form-switch d-flex justify-content-between align-items-center ps-0">
                        <label class="fw-bold text-danger">SECURITY MODE</label>
                        <input class="form-check-input" type="checkbox" id="swSecurity" onclick="toggleSecurity()">
                    </div>
                </div>
                
                <div id="mainStatusBadge" class="badge bg-secondary w-100 p-3 mb-4 fs-5">CONNECTING...</div>
                
                <div class="system-item"><i id="fanIcon" class="bi bi-fan fs-2"></i><h6>Exhaust</h6><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="swExFan" onclick="toggleRelay('ExFan')"></div></div>
                <div class="system-item"><i id="coolFanIcon" class="bi bi-snow fs-2"></i><h6>Cooling</h6><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="swCooling" onclick="toggleRelay('Cooling')"></div></div>
                <div class="system-item"><i id="sprinklerIcon" class="bi bi-moisture fs-2"></i><h6>Sprinkler</h6><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="swSprinkler" onclick="toggleRelay('Sprinkler')"></div></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDO3vqJGU-DfvdbNxN9wYj_7yzVQMtOAcY",
        authDomain: "environment-monitoring-s-1885c.firebaseapp.com",
        databaseURL: "https://environment-monitoring-s-1885c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "environment-monitoring-s-1885c",
        storageBucket: "environment-monitoring-s-1885c.firebasestorage.app",
        messagingSenderId: "473456562150",
        appId: "1:473456562150:web:7705fad07eb2091e975027"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- CONNECTION WATCHDOG ---
    let offlineTimer;
    const TIMEOUT_MS = 8000; // 8 Seconds without heartbeat = Offline

    function markOffline() {
        const badge = document.getElementById('mainStatusBadge');
        badge.innerText = "⚠️ ESP32 OFFLINE";
        badge.className = "badge bg-danger w-100 p-3 mb-4 fs-5 offline-pulse";

        // Reset text to "--"
        document.getElementById('valTemp').innerText = "--";
        document.getElementById('valHum').innerText = "--";
        document.getElementById('valGas').innerText = "--";
        document.getElementById('valSmoke').innerText = "--";
        
        // Reset motion/vib
        document.getElementById('valVib').innerText = "--";
        document.getElementById('valVib').className = "fw-bold text-muted";
        document.getElementById('valMotion').innerText = "--";
        document.getElementById('valMotion').className = "fw-bold text-muted";

        // Reset progress bars
        document.getElementById('barHum').style.width = "0%";
        document.getElementById('barGas').style.width = "0%";
        document.getElementById('barSmoke').style.width = "0%";
    }

    // Start the timer initially in case the ESP32 is already offline when page loads
    offlineTimer = setTimeout(markOffline, TIMEOUT_MS);

    // READ SENSORS & HEARTBEAT
    onValue(ref(db, 'Device-1/Status'), (snap) => {
        const d = snap.val(); 
        if(!d) return;

        // The ESP32 sent data! Reset the countdown timer.
        clearTimeout(offlineTimer);
        const badge = document.getElementById('mainStatusBadge');
        badge.innerText = "SYSTEM ONLINE";
        badge.className = "badge bg-success w-100 p-3 mb-4 fs-5";
        offlineTimer = setTimeout(markOffline, TIMEOUT_MS);

        // Update Values
        document.getElementById('valTemp').innerText = d.Temp;
        document.getElementById('valHum').innerText = d.Hum;
        document.getElementById('valGas').innerText = d["MQ-135"];
        document.getElementById('valSmoke').innerText = d["MQ-2"];
        
        document.getElementById('valVib').innerText = d.Vibration == 1 ? "DETECTED!" : "CLEAR";
        document.getElementById('valVib').className = d.Vibration == 1 ? "fw-bold text-danger" : "fw-bold text-muted";
        
        document.getElementById('valMotion').innerText = d.PIR == 1 ? "ACTIVITY" : "CLEAR";
        document.getElementById('valMotion').className = d.PIR == 1 ? "fw-bold text-warning" : "fw-bold text-muted";
        
        document.getElementById('barHum').style.width = d.Hum + "%";
        document.getElementById('barGas').style.width = Math.min((d["MQ-135"]/1000)*100, 100) + "%";
        document.getElementById('barSmoke').style.width = Math.min((d["MQ-2"]/1000)*100, 100) + "%";
    });

    // READ CONTROLS (Sync UI Switches to DB State)
    onValue(ref(db, 'Device-1/Controls'), (snap) => {
        const c = snap.val(); if(!c) return;
        document.getElementById('swExFan').checked = (c.ExFan === "ON");
        document.getElementById('swCooling').checked = (c.Cooling === "ON");
        document.getElementById('swSprinkler').checked = (c.Sprinkler === "ON");
        document.getElementById('swSecurity').checked = (c.SecurityMode === "ARMED");
        
        // Update Icons Animation
        document.getElementById('fanIcon').classList.toggle('spin-active', c.ExFan === "ON");
        document.getElementById('coolFanIcon').classList.toggle('spin-active', c.Cooling === "ON");
    });

    // READ THEFT ALERTS
    onValue(ref(db, 'Device-1/Alert/Theft'), (snap) => {
        const isTheft = snap.val();
        document.getElementById('theftBanner').style.display = isTheft ? "block" : "none";
        document.body.classList.toggle('hazard-bg', isTheft);
    });

    // --- BUTTON AND SWITCH FUNCTIONS WRITING TO DB ---
    window.toggleRelay = (dev) => {
        const isChecked = document.getElementById('sw'+dev).checked;
        update(ref(db, 'Device-1/Controls'), { [dev]: isChecked ? "ON" : "OFF" });
    };

    window.toggleSecurity = () => {
        const isChecked = document.getElementById('swSecurity').checked;
        update(ref(db, 'Device-1/Controls'), { SecurityMode: isChecked ? "ARMED" : "DISARMED" });
    };

    window.stopAlert = () => {
        update(ref(db, 'Device-1/Alert'), { Theft: false });
        update(ref(db, 'Device-1/Controls'), { SecurityMode: "DISARMED" });
    };
</script>
</body>
</html>
